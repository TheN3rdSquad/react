<!DOCTYPE html>
<html>
	<head>
		<title>Functional Table</title>
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="table.css" />
	</head>
	<body>
		<div id="app">
			<!-- my app renders here -->
		</div>
		<script src="react/react.js"></script>
		<script src="react/react-dom.js"></script>
		<script src="react/babel.js"></script>
		<script src="react/prop-types.js"></script>
		<script type="text/babel">
			function clone(o) {
				return JSON.parse(JSON.stringify(o));
			}

			const useState = React.useState;
			const useEffect = React.useEffect;

			let dataLog = [];
			let auxLog = [];
			let isReplaying = false;
			let replayID = null;

			function replay() {
				isReplaying = true;
				let idx = 0;
				replayID = setInterval(() => {
					const [data, fn] = dataLog[idx];
					fn(data);
					auxLog[idx] && auxLog[idx].forEach((log) => {
						const [data, fn] = log;
						fn(data);
					});
					idx++;
					if (idx > dataLog.length - 1) {
						isReplaying = false;
						clearInterval(replayID);
						return;
					}
				}, 1000);
			}

			function useLoggedState(initialValue, isData) {
				const [state, setState] = useState(initialValue);

				useEffect(() => {
					if (isReplaying) {
						return;
					}
					if (isData) {
						dataLog.push([clone(state), setState]);
					} else {
						const idx = dataLog.length - 1;
						if (!auxLog[idx]) {
							auxLog[idx] = [];
						}
						auxLog[idx].push([state, setState]);
					}
				}, [state]);

				return [state, setState];
			}

			function Example({ layout }) {
				if (layout === null) {
					return null;
				}

				if (layout) {
					React.useLayoutEffect(() => {
						const table = document.getElementsByTagName('table')[0];
						console.log(table.offsetWidth);
						table.width='250px';
					}, []);
				} else {
					React.useEffect(() => {
						const table = document.getElementsByTagName('table')[0];
						console.log(table.offsetWidth);
						table.width='250px';
					}, []);
				}

				return (
					<table>
						<thead>
							<tr>
								<th>Random</th>
							</tr>
						</thead>
						<tbody>
							{Array.from(Array(10000)).map((_, idx) => (
								<tr key={idx}>
									<td width={Math.random() * 800}>{Math.random()}</td>
								</tr>
							))}
						</tbody>
					</table>
				);
			}

			function ExampleParent() {
				const [layout, setLayout] = React.useState(null);
				return (
					<div>
						<button onClick={() => setLayout(false)}>useEffect</button>{' '}
						<button onClick={() => setLayout(true)}>useLayoutEffect</button>{' '}
						<button onClick={() => setLayout(null)}>clear</button>
						<Example layout={layout} />
					</div>
				);
			}

			function Excel({headers, initialData}) {
				const [data, setData] = useLoggedState(initialData, true);
				const [sorting, setSorting] = useLoggedState({
					column: null,
					descending: false,
				});
				const [edit, setEdit] = useLoggedState(null);
				const [search, setSearch] = useLoggedState(false);
				const [preSearchData, setPreSearchData] = useLoggedState(null);

				useEffect(() => {
					function keydownHandler(e) {
						if (e.altKey && e.shiftKey && e.keyCode === 82) {
							// ALT + SHIFT + R(replay)
							replay();
						}
					}
					document.addEventListener('keydown', keydownHandler);
					return () => {
						document.removeEventListener('keydown', keydownHandler);
						clearInterval(replayID);
						dataLog = [];
						auxLog = [];
					};
				}, []);

				function sort(e) {
					const column = e.target.cellIndex;
					const descending = sorting.column === column && !sorting.descending;
					const dataCopy = clone(data);

					dataCopy.sort((a, b) => {
						if (a[column] === b[column]) {
							return 0;
						}

						return descending 
							? a[column] < b[column] ? 1 : -1
							: a[column] > b[column] ? 1 : -1;
					});

					setData(dataCopy);
					setSorting({ column, descending });
				}

				function showEditor(e) {
					setEdit({
						row: parseInt(e.target.parentNode.dataset.row, 10),
						column: e.target.cellIndex,
					});
				}

				function save(e) {
					e.preventDefault();
					const input = e.target.firstChild;
					const dataCopy = clone(data);
					dataCopy[edit.row][edit.column] = input.value;
					setEdit(null);
					setData(dataCopy);
				}

				return (
					<table>
						<thead onClick={sort}>
							<tr>
								{headers.map((title, idx) => {
									if (sorting.column === idx) {
										title += sorting.descending ? ' \u2191' : ' \u2193';
									}
									return <th key={idx}>{title}</th>;
								})}
							</tr>
						</thead>
						<tbody onDoubleClick={showEditor}>
							{data.map((row, rowidx) => (
								<tr key={rowidx} data-row={rowidx}>
									{row.map((cell, columnidx) => {
										if (edit && edit.row === rowidx
											&& edit.column === columnidx) {
											cell = (
												<form onSubmit={save}>
													<input type="text" defaultValue={cell} />
												</form>
											);
										}
										return <td key={columnidx}>{cell}</td>
									})}
								</tr>
							))}
						</tbody>
					</table>
				);
			}

			Excel.propTypes = {
				headers: PropTypes.arrayOf(PropTypes.string),
				initialData: PropTypes.arrayOf(PropTypes.arrayOf(PropTypes.string)),
			};

			const headers = ['Book', 'Author', 'Language', 'Published', 'Sales'];

			const data = [
				[
					'A Tale of Two Cities',
					'Charles Dickens',
					'English',
					'1859',
					'200 million',
				],
				[
					'Le Petit Prince (The Little Prince)',
					'Antoine de Saint-Exup√©ry',
					'French',
					'1943',
					'150 million',
				],
				[
					"Harry Potter and the Philosopher's Stone",
					'J. K. Rowling',
					'English',
					'1997',
					'120 million',
				],
				[
					'And Then There Were None',
					'Agatha Christie',
					'English',
					'1939',
					'100 million',
				],
				[
					'Dream of the Red Chamber',
					'Cao Xueqin',
					'Chinese',
					'1791',
					'100 million',
				],
				['The Hobbit', 'J. R. R. Tolkien', 'English', '1937', '100 million'],
			];
			
			// <Excel headers={headers} initialData={data} />
			ReactDOM.render(
				<Excel headers={headers} initialData={data} />,
				document.getElementById('app'),
			);
		</script>
	</body>
</html>